#!/usr/bin/env ruby

require 'optparse'

begin
  require 'redwood'
rescue LoadError
  raise if $!.to_s !~ /redwood/
  libdir = File.expand_path("../../lib", __FILE__).sub(/^#{Dir.pwd}/, '.')
  if !$:.include?(libdir)
    $:.unshift libdir
    retry
  end
  raise
end

options = {
  :follow_symlinks => false,
  :show_hidden_files => false
}

def statement(tree)
  directories = 0
  files = 0
  tree.descendants.each do |f|
    directories += 1 if f.directory?
    files += 1 if f.file?
  end
  "#{directories} directories, #{files} file"
end

def setup_tree(tree, options)
  if !options[:follow_symlinks]
    tree.walk do |f|
      if f.symlink?
        f.value = "#{f.basename} -> #{f.readlink}"
        f.children.each {|child| child.unlink }
      end
    end
  end
  # tree.walk {|f| f.unlink if f.basename.index('.').eql?(0) }if !show_hidden_files
  tree
end

if ARGV.empty?
  tree = setup_tree(Redwood::FileNode.scandir('.'), options)
  puts tree.view(:value)
  puts "\n"
  puts statement(tree)
  exit
end
  